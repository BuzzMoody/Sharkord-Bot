name: Manual Release (PHP)

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2' # Adjust to your PHP version

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Version in composer.json
        id: bump_version
        run: |
          # 1. Get current version from composer.json
          CURRENT_VERSION=$(jq -r .version composer.json)
          echo "Current version: $CURRENT_VERSION"
          
          # 2. Calculate new version using a simple script
          # Break version into array (e.g., 1.0.0 -> [1, 0, 0])
          IFS='.' read -r -a parts <<< "$CURRENT_VERSION"
          major="${parts[0]}"
          minor="${parts[1]}"
          patch="${parts[2]}"
          
          if [ "${{ inputs.version_type }}" == "major" ]; then
            major=$((major + 1))
            minor=0
            patch=0
          elif [ "${{ inputs.version_type }}" == "minor" ]; then
            minor=$((minor + 1))
            patch=0
          else
            patch=$((patch + 1))
          fi
          
          NEW_VERSION="$major.$minor.$patch"
          echo "New version: $NEW_VERSION"
          
          # 3. Update composer.json using a temp file
          jq --arg v "$NEW_VERSION" '.version = $v' composer.json > composer.tmp && mv composer.tmp composer.json
          
          # 4. Commit and Tag
          git add composer.json
          git commit -m "release: bump version to $NEW_VERSION"
          git tag "v$NEW_VERSION"
          git push origin main --tags
          
          # 5. Output for next step
          echo "NEW_TAG=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.bump_version.outputs.NEW_TAG }}
          name: Release ${{ steps.bump_version.outputs.NEW_TAG }}
          generate_release_notes: true

      - name: Reset dev branch
        run: |
          # Delete dev branch if it exists (remotely)
          git push origin --delete dev || true
          
          # Delete local dev branch if it exists
          git branch -D dev || true
          
          # Ensure we're on main branch
          git checkout main
          
          # Create new dev branch from current main
          git checkout -b dev
          
          # Push new dev branch to remote
          git push origin dev